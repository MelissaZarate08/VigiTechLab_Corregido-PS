import{C as O}from"./auto-iNj9SIZ4.js";import{T as i,i as U}from"./wsService-CZqLgdW-.js";import{n as k}from"./index-DG_JPB1t.js";const P="http://54.211.156.108:8081",A=8,F=5e3;function H(){document.getElementById("btn-menu").onclick=()=>document.getElementById("sidebar").classList.add("visible"),document.getElementById("btn-close").onclick=()=>document.getElementById("sidebar").classList.remove("visible"),document.getElementById("btn-user").onclick=()=>document.getElementById("dropdown-user").classList.toggle("hidden"),document.getElementById("logout").onclick=()=>{localStorage.removeItem("authToken"),localStorage.removeItem("currentUser"),k("#/")};try{const t=JSON.parse(localStorage.getItem("currentUser"))||{};document.getElementById("user-name").textContent=t.name||"Usuario"}catch{}document.querySelectorAll(".menu a").forEach(t=>t.classList.remove("active")),document.querySelector('.menu a[href="#/particle"]').classList.add("active"),document.getElementById("toggle-sensors").onclick=t=>t.target.parentElement.classList.toggle("open");let E=null;function v(){E=U(M)}function _(){E?.close()}const d=document.getElementById("system-toggle"),S=document.getElementById("system-label");let r=localStorage.getItem("vigitech-system")||"on";d.checked=r==="on",S.textContent=`Sistema: ${r.toUpperCase()}`,d.onchange=async()=>{const t=d.checked?"on":"off";await fetch(`${P}/command/system`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t})}),localStorage.setItem("vigitech-system",t),S.textContent=`Sistema: ${t.toUpperCase()}`;const e=document.getElementById("particle-toggle"),a=document.getElementById("particle-label");e.disabled=t==="off",a.style.opacity=t==="off"?.5:1,t==="off"?_():v(),i({text:`Sistema ${t==="on"?"encendido":"apagado"}`,duration:3e3,gravity:"top",position:"right",style:{background:t==="on"?"#4caf50":"#e63946"}}).showToast()};const c=document.getElementById("particle-toggle"),m=document.getElementById("particle-label");let B=localStorage.getItem("vigitech-particle")||"on";c.checked=B==="on",m.textContent=`Partículas: ${B.toUpperCase()}`,r==="off"&&(c.disabled=!0,m.style.opacity=.5),c.onchange=async()=>{const t=c.checked?"on":"off";await fetch(`${P}/command/sensor`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sensor:"particles",action:t})}),localStorage.setItem("vigitech-particle",t),m.textContent=`Partículas: ${t.toUpperCase()}`,i({text:`Sensor de partículas ${t==="on"?"activado":"desactivado"}`,duration:3e3,gravity:"top",position:"right",style:{background:t==="on"?"#4caf50":"#e63946"}}).showToast()};const g={PM1_0:12,PM2_5:35,PM10:50};let u=!1,T=0;const s=document.getElementById("alert-sound");let p=!1;document.addEventListener("click",()=>{p||s.play().then(()=>{s.pause(),s.currentTime=0,p=!0}).catch(()=>{})},{once:!0});const y=document.getElementById("particleChart"),h=document.getElementById("particleTable"),f=document.getElementById("btn-chart"),b=document.getElementById("btn-table"),w=y.getContext("2d");let I=null,n=[];function L(){const t=n.map(o=>o.timestamp.slice(11,16)),e=n.map(o=>o.pm1_0),a=n.map(o=>o.pm2_5),l=n.map(o=>o.pm10);I&&I.destroy(),I=new O(w,{type:"line",data:{labels:t,datasets:[{label:"PM1.0",data:e,tension:.3,fill:!1},{label:"PM2.5",data:a,tension:.3,fill:!1},{label:"PM10",data:l,tension:.3,fill:!1}]}})}function C(){const t=h.querySelector("tbody");t.innerHTML="",n.forEach(e=>t.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${e.timestamp.slice(11,16)}</td>
        <td>${e.pm1_0.toFixed(2)}</td>
        <td>${e.pm2_5.toFixed(2)}</td>
        <td>${e.pm10.toFixed(2)}</td>
      </tr>`))}f.onclick=()=>{y.classList.remove("hidden"),h.classList.add("hidden"),L(),f.classList.add("active"),b.classList.remove("active")},b.onclick=()=>{h.classList.remove("hidden"),y.classList.add("hidden"),C(),b.classList.add("active"),f.classList.remove("active")};function M(t){if(localStorage.getItem("vigitech-system")!=="on")return;if(localStorage.getItem("vigitech-particle")!=="on"){const x=Date.now();x-T>F&&(i({text:"Sensor de partículas está apagado",duration:3e3}).showToast(),T=x);return}if(!t.id?.startsWith("p-"))return;n.push(t),n.length>A&&n.shift();const e=document.getElementById("rt-pm1"),a=document.getElementById("rt-pm2"),l=document.getElementById("rt-pm10");e&&a&&l&&(e.textContent=t.pm1_0.toFixed(2),a.textContent=t.pm2_5.toFixed(2),l.textContent=t.pm10.toFixed(2)),L(),C();const o=t.pm1_0>g.PM1_0||t.pm2_5>g.PM2_5||t.pm10>g.PM10;o&&!u&&(u=!0,p&&(s.currentTime=0,s.play().catch(()=>{})),i({text:"Alerta de partículas alto",duration:5e3,gravity:"top",position:"right",style:{background:"#e63946"}}).showToast()),o||(u=!1)}v();const $=document.getElementById("modal-sos");document.getElementById("btn-sos").onclick=()=>$.classList.toggle("hidden"),document.getElementById("btn-stats").onclick=()=>k("#/particleProbability"),history.pushState(null,null,location.href),window.addEventListener("popstate",()=>history.pushState(null,null,location.href))}export{H as initParticleSensor};
