import{T as r,i as O}from"./wsService-CZqLgdW-.js";import{n as D}from"./index-DG_JPB1t.js";const k="http://54.211.156.108:8081",H=1e3;function R(){const B=document.getElementById("btn-menu"),T=document.getElementById("btn-close"),c=document.getElementById("sidebar");B.addEventListener("click",()=>c.classList.add("visible")),T.addEventListener("click",()=>c.classList.remove("visible")),document.getElementById("btn-user").addEventListener("click",()=>document.getElementById("dropdown-user").classList.toggle("hidden")),document.getElementById("logout").addEventListener("click",()=>{localStorage.removeItem("authToken"),localStorage.removeItem("currentUser"),D("#/")});let g={};try{g=JSON.parse(localStorage.getItem("currentUser"))||{}}catch{}const d=g.name||"Usuario";document.getElementById("user-name").textContent=d,document.getElementById("welcome-name").textContent=d,document.querySelectorAll(".menu a").forEach(t=>{t.getAttribute("href")==="#/dashboard"&&t.classList.add("active"),t.addEventListener("click",s=>{document.querySelector(".menu a.active")?.classList.remove("active"),s.target.classList.add("active"),c.classList.remove("visible")})}),document.getElementById("toggle-sensors").addEventListener("click",t=>t.target.parentElement.classList.toggle("open"));const n=document.getElementById("alert-sound");let i=!1;document.addEventListener("click",()=>{i||n.play().then(()=>{n.pause(),n.currentTime=0,i=!0}).catch(()=>{})},{once:!0});const a={gas:{LPG:1e3,CO:50,Smoke:50},particle:{PM1_0:12,PM2_5:35,PM10:50}};let e={gas:!1,particle:!1,motion:!1},u,p;function y(){u=O(M),h(),p=setInterval(h,H)}function w(){u?.close(),clearInterval(p)}function M(t){if(localStorage.getItem("vigitech-system")!=="on")return;const s=document.getElementById("gas-status"),E=document.getElementById("particle-status"),b=document.getElementById("motion-status");if(!s||!E||!b)return;const l={gas:localStorage.getItem("vigitech-gas")==="on",particle:localStorage.getItem("vigitech-particle")==="on",motion:localStorage.getItem("vigitech-motion")==="on"},L=Date.now(),_=5e3,C={gas:+localStorage.getItem("vigitech-alert-gas")||0,particle:+localStorage.getItem("vigitech-alert-particle")||0,motion:+localStorage.getItem("vigitech-alert-motion")||0};function m(o,x){L-C[o]>_&&(r({text:x,duration:4e3,gravity:"top",position:"right",style:{background:"#999"}}).showToast(),localStorage.setItem(`vigitech-alert-${o}`,L))}if(t.id?.startsWith("g-")){if(!l.gas){m("gas","Sensor de gas está apagado");return}s.innerHTML=`<strong>Gas:</strong><br>LPG: ${t.lpg}<br>CO: ${t.co}<br>Humo: ${t.smoke}`;const o=t.lpg>a.gas.LPG||t.co>a.gas.CO||t.smoke>a.gas.Smoke;o&&!e.gas&&(e.gas=!0,i&&(n.currentTime=0,n.play().catch(()=>{})),r({text:"Alerta de gas alto",duration:5e3,gravity:"top",position:"right",style:{background:"#e63946"}}).showToast()),o||(e.gas=!1)}if(t.id?.startsWith("p-")){if(!l.particle){m("particle","Sensor de partículas está apagado");return}E.innerHTML=`<strong>Partículas:</strong><br>PM1.0: ${t.pm1_0}<br>PM2.5: ${t.pm2_5}<br>PM10: ${t.pm10}`;const o=t.pm1_0>a.particle.PM1_0||t.pm2_5>a.particle.PM2_5||t.pm10>a.particle.PM10;o&&!e.particle&&(e.particle=!0,i&&(n.currentTime=0,n.play().catch(()=>{})),r({text:"Alerta de partículas alto",duration:5e3,gravity:"top",position:"right",style:{background:"#e63946"}}).showToast()),o||(e.particle=!1)}if(t.id?.startsWith("motion")){if(!l.motion){m("motion","Sensor de movimiento está apagado");return}const o=t.motion_detected?"Detectado":"Sin movimiento";b.innerHTML=`<strong>Movimiento:</strong><br>Estado: ${o}<br>Intensidad: ${t.intensity??"–"}`,t.motion_detected&&!e.motion&&(e.motion=!0,i&&(n.currentTime=0,n.play().catch(()=>{})),r({text:"Se detectó movimiento",duration:5e3,gravity:"top",position:"right",style:{background:"#e63946"}}).showToast()),t.motion_detected||(e.motion=!1)}}const f=document.getElementById("camera-stream");async function h(){if(localStorage.getItem("vigitech-system")==="on")try{const s=await(await fetch(`${k}/sensor/stream?limit=1`)).json();s.length&&f&&(f.src=`${s[0].image_path}?t=${Date.now()}`)}catch{}}const v=document.getElementById("system-toggle"),I=document.getElementById("system-label");let S=localStorage.getItem("vigitech-system")||"on";v.checked=S==="on",I.textContent=`Sistema: ${S.toUpperCase()}`;async function $(t){try{await fetch(`${k}/command/system`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t})}),localStorage.setItem("vigitech-system",t),I.textContent=`Sistema: ${t.toUpperCase()}`,r({text:`Sistema ${t==="on"?"encendido":"apagado"}`,duration:3e3,gravity:"top",position:"right",style:{background:t==="on"?"#4caf50":"#e63946"}}).showToast(),t==="off"?w():(e={gas:!1,particle:!1,motion:!1},y())}catch(s){console.error("Error cambiando estado del sistema",s)}}v.addEventListener("change",t=>$(t.target.checked?"on":"off")),y();const P=document.getElementById("modal-sos");document.getElementById("btn-sos").onclick=()=>P.classList.toggle("hidden"),document.getElementById("close-sos").onclick=()=>{document.getElementById("modal-sos").classList.add("hidden")},history.pushState(null,null,location.href),window.addEventListener("popstate",()=>history.pushState(null,null,location.href))}export{R as initDashboard};
